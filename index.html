<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap/dist/css/bootstrap.min.css">
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <div class='container' id='app'>
      <h1>{{ host }}</h1>
      <rf-repository  v-for='repository in repositories' :repository="repository"></rf-repository>
    </div>
  </body>

  <script type="text/x-template" id="repository-template">
    <div class="panel panel-default">
      <div class="panel-heading">
        <div class="row">
          <div class="col-xs-6"><rf-glyph :icon="opened ? 'folder-open' : 'folder-close'"></rf-glyph> {{ repository }}</div>
          <div class="col-xs-6 text-right">
            <rf-glyphbutton :click="toggle" :icon="opened ? 'chevron-up' : 'chevron-down'"></rf-glyphbutton>
          </div>
        </div>
      </div>
      <div v-if="opened" class="list-group">
        <div v-if="!loaded" class="list-group-item"><rf-glyph icon="hourglass"></rf-glyph> Loading manifests</div>
        <div v-if="loaded && manifests.length == 0" class="list-group-item"><rf-glyph icon="info-sign"></rf-glyph> No manifests in repository</div>
        <rf-manifest v-for="manifest in manifests" :manifest="manifest" :repository="repository" v-on:deleted="load"></rf-manifest>
      </div>
    </div>
  </script>

  <script type="text/x-template" id="manifest-template">
    <div class="list-group-item">
      <div class="row">
        <div class="col-xs-3">
          <span v-for="tag in manifest.tags" class="badge"><rf-glyph icon="tag"></rf-glyph> {{ tag }}</span>
        </div>
        <div class="col-xs-3">
          <rf-glyph icon="list"></rf-glyph> {{ manifest.layers.length }} layers
        </div>
        <div class="col-xs-3">
          <rf-glyph icon="compressed"></rf-glyph> {{ manifest.size | bytestomb }} MB
        </div>
        <div class="col-xs-3 text-right">
          <rf-glyphbutton :click="remove" look="danger" icon="erase"></rf-glyphbutton>
        </div>
      </div>
    </div>
  </script>

  <script type="text/x-template" id="glyphbutton-template">
    <a v-on:click="click" :class="'btn btn-xs btn-' + look">
      <rf-glyph :icon="icon"></rf-icon><slot></slot>
    </a>
  </script>

  <script>
    Vue.filter('bytestomb', function (value) {
      return (value / 1000000).toFixed(2)
    })

    Vue.component('rf-glyph', {
      props: ['icon'],
      template: '<span :class="\'glyphicon glyphicon-\' + icon"></span>'
    })

    Vue.component('rf-glyphbutton', {
      props: {
        icon: { type: String, required: true },
        look: { type: String, default: 'default' },
        click: { type: Function, required: true }
      },
      template: '#glyphbutton-template'
    })

    Vue.component('rf-manifest', {
      props: ['manifest', 'repository'],
      template: '#manifest-template',
      methods: {
        remove: function() {
          axios.delete('/v2/' + this.repository + '/manifests/' + this.manifest.digest).then((res) => {
            this.$emit('deleted')
          })
        }
      }
    })

    Vue.component('rf-repository', {
      props: ['repository'],
      data: function () { return {
        opened: false,
        loaded: false,
        pendingRequests: 0,
        manifests: []
      }},
      template: '#repository-template',
      methods: {

        load: function () {
          this.manifests = []
          this.loaded = false
          this.opened = true
          this.pendingRequests = 1
          axios.get('/v2/' + this.repository + '/tags/list').then((res) => {
            if (res.data.tags == null) {
              this.pendingRequests = 0
              this.loaded = true
              return
            }
            var manifestsByDigest = {}
            this.pendingRequests = res.data.tags.length
            res.data.tags.forEach((tag) => {
              axios.get('/v2/' + this.repository + '/manifests/' + tag, {
                headers: {
                  'accept': 'application/vnd.docker.distribution.manifest.v2+json',
                  'if-none-match': null
                }
              }).then((res) => {
                var digest = res.headers['docker-content-digest']
                manifestsByDigest[digest] = manifestsByDigest[digest] || {
                  digest: digest,
                  tags: [],
                  layers: res.data.layers,
                  size: res.data.layers.reduce((a, l) => { return a + l.size }, 0)
                }
                manifestsByDigest[digest].tags.push(tag)
                
                if (--this.pendingRequests <= 0) {
                  for (digest in manifestsByDigest) { this.manifests.push(manifestsByDigest[digest]) }
                  this.loaded = true
                }
              })
            })
          })
        },

        close: function () {
          this.opened = false
          this.loaded = false
          this.manifests = []
        },

        toggle: function () {
          if (this.opened) {
            this.close()
          } else {
            this.load()
          }
        }

      }
    })

    var app = new Vue({
      el: '#app',
      data: {
        host: document.location.hostname,
        repositories: []
      },
      methods: {
        loadRepositories: function () {
          axios.get('/v2/_catalog').then((res) => {
            this.repositories = res.data.repositories
          })
        }
      }
    })

    app.loadRepositories()
  </script>
</html>
