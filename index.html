<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
      .glyphicon { margin: 4px; }
      .list-group .glyphicon { margin-left: 40px; }
      .repository .panel-heading { cursor: pointer; }
    </style>
  </head>

  <body>
    <div class='container' id='app'>
      <h1>{{ host }}</h1>
      <rf-repository  v-for='repository in repositories' :repository="repository"></rf-repository>
    </div>
  </body>

  <script type="text/x-template" id="repository-template">
    <div class="panel panel-default repository">
      <div v-on:click="toggleOpen" class="panel-heading">
        <span :class="'glyphicon glyphicon-folder-' + (open ? 'open' : 'close')"></span> {{ repository }}
      </div>
      <div class="list-group">
        <div v-if="open && tags == null" class="list-group-item"><span class="glyphicon glyphicon-info-sign"></span>Repository contains no tags</div>
        <rf-manifest v-for="tag in tags" :repository="repository" :tag="tag"></rf-manifest>
      </div>
    </div>
  </script>

  <script type="text/x-template" id="manifest-template">
    <div class="list-group-item">
      <span class="glyphicon glyphicon-tag"></span> {{ tag }}
      <span v-if="layercount > 0">
        <span class="glyphicon glyphicon-list"></span> {{ layercount }} layers
        <span class="glyphicon glyphicon-compressed"></span> {{ size | bytestomb }} MB
      </span>
    </div>
  </script>

  <script>
    Vue.filter('bytestomb', function (value) {
      return (value / 1000000).toFixed(2)
    })

    Vue.component('rf-repository', {
      props: ['repository'],
      data: function () { return {
        tags: undefined
      }},
      computed: {
        open: function () { return this.tags !== undefined }
      },
      template: '#repository-template',
      methods: {
        toggleOpen: function () {
          if (this.open) {
            this.tags = undefined
          }else {
            axios.get('/v2/' + this.repository + '/tags/list').then((res) => {
              this.tags = res.data.tags
            })
          }
        }
      }
    })

    Vue.component('rf-manifest', {
      props: ['repository', 'tag'],
      data: function () { return { layers: [] }},
      computed: {
        layercount: function () { return this.layers.length },
        size: function () { return this.layers.reduce((accumulator, layer) => { return accumulator + layer.size }, 0) }
      },
      template: '#manifest-template',
      created: function () {
        axios.get('/v2/' + this.repository + '/manifests/' + this.tag, {
          headers: { Accept: 'application/vnd.docker.distribution.manifest.v2+json' }
        }).then((res) => {
          this.layers = res.data.layers
        })
      }
    })

    var app = new Vue({
      el: '#app',
      data: {
        host: document.location.hostname,
        repositories: []
      },
      methods: {
        loadRepositories: function () {
          axios.get('/v2/_catalog').then((res) => {
            this.repositories = res.data.repositories
          })
        }
      }
    })

    app.loadRepositories()
  </script>
</html>
